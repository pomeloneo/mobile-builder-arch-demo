# 任务调度

<cite>
**本文档引用的文件**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)
- [build-tree-job.ts](file://packages/h5-builder/src/jobs/build-tree-job.ts)
- [trigger-render-job.ts](file://packages/h5-builder/src/jobs/trigger-render-job.ts)
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)
- [schema.service.ts](file://packages/h5-builder/src/services/schema.service.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)
- [demo-progressive.tsx](file://packages/h5-builder/src/demo-progressive.tsx)
</cite>

## 目录
1. [任务调度系统概述](#任务调度系统概述)
2. [核心组件分析](#核心组件分析)
3. [页面生命周期与任务编排](#页面生命周期与任务编排)
4. [Job接口设计与执行机制](#job接口设计与执行机制)
5. [异步任务编排与依赖管理](#异步任务编排与依赖管理)
6. [自定义Job开发指南](#自定义job开发指南)
7. [调度性能监控方案](#调度性能监控方案)
8. [常见问题排查指南](#常见问题排查指南)

## 任务调度系统概述

任务调度系统是H5页面构建流程的核心控制机制，负责有序执行页面初始化过程中的各项关键任务。该系统通过JobScheduler协调GetSchemaJob、BuildTreeJob、TriggerRenderJob等任务的执行顺序，确保页面构建流程的正确性和高效性。调度系统实现了渐进式渲染和关键路径优化，通过精确控制任务执行时机来提升页面加载性能。

**Section sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)

## 核心组件分析

### JobScheduler核心机制

JobScheduler是任务调度系统的核心组件，负责管理任务的注册、准备和执行。它通过阶段化控制确保任务按正确的顺序执行，同时提供性能监控功能。

```mermaid
classDiagram
class JobScheduler {
+currentPhase : K
-_jobPools : Map<string, AbstractJob<T, K>>
-_unconstructedJobs : Map<K, JobDescriptor[]>
-_costRecorder : CostRecorder
+registerJob(phase : K, ctor : Constructor, ...args : any[]) : void
+addJob(job : AbstractJob<T, K>) : void
+getJob(name : string) : AbstractJob<T, K> | undefined
+prepare(phase : K) : boolean
+wait(phase : K) : Promise<void>
+advanceToPhase(phase : K) : void
+getCost() : string
}
class JobDescriptor {
+ctor : Constructor
+staticArguments : any[]
}
class CostRecorder {
-_jobCost : Record<string, Trace>
+record(jobName : string, lifecycle : string|number, cost : number) : void
+toString() : string
}
JobScheduler --> JobDescriptor : "包含"
JobScheduler --> CostRecorder : "使用"
```

**Diagram sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)

### AbstractJob抽象基类

AbstractJob定义了所有任务的通用接口和行为规范，通过模板方法模式确保子类实现必要的生命周期方法。

```mermaid
classDiagram
class AbstractJob {
+name : string
-_name : string
-_store : Map<K, Barrier[]>
+shouldWait(phase : K) : boolean
+wait(phase : K) : Promise<void>
+prepare(phase : K) : void
+_setBarrier(phase : K, barrier : Barrier) : void
+_executePhase(phase : K) : void
}
class GetSchemaJob {
+_executePhase(phase : PageLifecycle) : Promise<void>
-_whenOpen() : Promise<void>
-_registerComponentLoader() : void
}
class BuildTreeJob {
+_executePhase(phase : PageLifecycle) : Promise<void>
-_whenPrepare() : Promise<void>
}
class TriggerRenderJob {
+_executePhase(phase : PageLifecycle) : void
-_triggerRender() : void
}
AbstractJob <|-- GetSchemaJob
AbstractJob <|-- BuildTreeJob
AbstractJob <|-- TriggerRenderJob
```

**Diagram sources**
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)
- [build-tree-job.ts](file://packages/h5-builder/src/jobs/build-tree-job.ts)
- [trigger-render-job.ts](file://packages/h5-builder/src/jobs/trigger-render-job.ts)

**Section sources**
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)
- [build-tree-job.ts](file://packages/h5-builder/src/jobs/build-tree-job.ts)
- [trigger-render-job.ts](file://packages/h5-builder/src/jobs/trigger-render-job.ts)

## 页面生命周期与任务编排

### 生命周期阶段定义

系统定义了清晰的页面生命周期阶段，每个阶段对应特定的构建任务，确保页面按序初始化。

```mermaid
stateDiagram-v2
[*] --> Open
Open --> LoadComponentLogic
LoadComponentLogic --> Prepare
Prepare --> RenderReady
RenderReady --> Render
Render --> Completed
Completed --> Idle
Idle --> [*]
note right of Open
获取页面 schema
注册组件资源加载器
end note
note right of LoadComponentLogic
加载组件逻辑 Model JS 资源
end note
note right of Prepare
构建模型树逻辑树
同时加载组件视图
end note
note right of RenderReady
模型树和视图资源
全部准备完成
end note
note right of Render
启动渲染
end note
note right of Completed
首屏视图数据填充
渐进式渲染方案
end note
note right of Idle
处理闲时任务
end note
```

**Diagram sources**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)

### 任务-生命周期映射

```mermaid
flowchart TD
A[Open] --> B[GetSchemaJob]
B --> C{获取Schema}
C --> D[注册组件加载器]
D --> E[预加载组件]
E --> F[LoadComponentLogic]
F --> G[组件服务]
G --> H[并发加载Model/View]
H --> I[Prepare]
I --> J[BuildTreeJob]
J --> K[构建模型树]
K --> L[RenderReady]
L --> M[所有资源准备完成]
M --> N[Render]
N --> O[TriggerRenderJob]
O --> P[触发React渲染]
P --> Q[Completed]
Q --> R[首屏数据填充]
R --> S[Idle]
S --> T[处理闲时任务]
classDef phase fill:#e1f5fe,stroke:#039be5;
class A,F,I,L,N,Q,S phase;
```

**Diagram sources**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)
- [build-tree-job.ts](file://packages/h5-builder/src/jobs/build-tree-job.ts)
- [trigger-render-job.ts](file://packages/h5-builder/src/jobs/trigger-render-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**Section sources**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)

## Job接口设计与执行机制

### 任务执行流程

```mermaid
sequenceDiagram
participant Scheduler as JobScheduler
participant Job as AbstractJob
participant Phase as 生命周期阶段
participant Barrier as Barrier
Phase->>Scheduler : prepare(阶段)
Scheduler->>Scheduler : 实例化待构造任务
Scheduler->>Job : prepare(阶段)
Job->>Job : _executePhase(阶段)
Job->>Barrier : _setBarrier(阶段, barrier)
Scheduler->>Scheduler : 记录任务耗时
Phase->>Scheduler : wait(阶段)
Scheduler->>Job : shouldWait(阶段)
alt 需要等待
Job->>Scheduler : true
Scheduler->>Barrier : wait()
Barrier->>Barrier : 返回Promise
Barrier->>Scheduler : Promise完成
else 不需要等待
Job->>Scheduler : false
end
Scheduler->>Scheduler : 更新当前阶段
Note over Scheduler,Barrier : 通过Barrier机制实现异步任务协调
```

**Diagram sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)

### 任务优先级管理

系统通过注册时机和依赖关系实现任务优先级管理。关键任务在早期阶段注册，确保优先执行。

```mermaid
graph TD
A[Open阶段] --> B[GetSchemaJob]
B --> C[获取Schema]
C --> D[注册组件加载器]
D --> E[预加载组件]
E --> F[LoadComponentLogic阶段]
F --> G[组件服务]
G --> H[高优先级组件]
G --> I[普通优先级组件]
G --> J[低优先级组件]
H --> K[Prepare阶段]
I --> K
J --> K
K --> L[BuildTreeJob]
style H fill:#ffccbc
style I fill:#c8e6c9
style J fill:#bbdefb
classDef priority fill:#ffeb3b,stroke:#f57f17;
class H priority;
```

**Diagram sources**
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**Section sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)

## 异步任务编排与依赖管理

### 组件加载依赖管理

系统通过组件元数据中的dependencies字段管理组件间的依赖关系，确保依赖组件先于依赖者加载。

```mermaid
graph TD
A[TabsContainer] --> |critical| B[TextCard]
A --> |critical| C[ProductCard]
D[ExperimentContainer] --> |normal| B
D --> |normal| C
E[GridLayoutContainer] --> |normal| F[ConditionalContainer]
classDef critical fill:#ff1744,color:#ffffff;
classDef high fill:#ff9100;
classDef normal fill:#64ffda;
classDef low fill:#7c4dff,color:#ffffff;
class A critical
class B,C high
class D,E,F normal
style A fill:#ff1744,color:#ffffff
style B,C fill:#ff9100
style D,E,F fill:#64ffda
```

**Diagram sources**
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)

### Barrier同步机制

Barrier是实现异步任务同步的关键机制，通过Promise模式协调任务完成状态。

```mermaid
classDiagram
class IBarrier {
    +isOpen() : boolean
    +open() : void
    +wait() : Promise<boolean>
}
class Barrier {
    -_isOpen : boolean
    -_promise : Promise<boolean>
    -_completePromise : (v : boolean) => void
    -_rejectPromise : (e : unknown) => void
    +isOpen() : boolean
    +open() : void
    +reject(e : unknown) : void
    +wait() : Promise<boolean>
}
IBarrier <|.. Barrier
class GetSchemaJob {
    -_schemaBarrier : Barrier
    -_whenOpen() : Promise<void>
}
GetSchemaJob --> Barrier : "使用"
note right of Barrier
    "初始状态为关闭<br/>调用open()后永久打开<br/>wait()返回Promise<br/>实现异步协调"
end note
```

**Diagram sources**
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)

**Section sources**
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)

## 自定义Job开发指南

### 自定义Job开发步骤

```mermaid
flowchart TD
A[创建新Job类] --> B[继承AbstractJob]
B --> C[实现_name属性]
C --> D[实现_executePhase方法]
D --> E[处理特定生命周期阶段]
E --> F[使用_setBarrier处理异步任务]
F --> G[注册到JobScheduler]
G --> H[在适当阶段执行]
style A fill:#e8f5e8
style B fill:#e8f5e8
style C fill:#e8f5e8
style D fill:#e8f5e8
style E fill:#e8f5e8
style F fill:#e8f5e8
style G fill:#e8f5e8
style H fill:#e8f5e8
```

### 错误处理与超时控制

自定义Job应实现完善的错误处理和超时控制机制，确保系统稳定性。

```mermaid
sequenceDiagram
participant Job as 自定义Job
participant Scheduler as JobScheduler
participant Timeout as 超时控制
Job->>Job : _executePhase(阶段)
Job->>Timeout : 设置超时定时器
alt 正常执行
Job->>Job : 执行业务逻辑
Job->>Job : 调用_openBarrier()
Job->>Timeout : 清除定时器
Job->>Scheduler : 任务完成
else 发生错误
Job->>Job : 捕获异常
Job->>Job : 记录错误日志
Job->>Job : 调用_rejectBarrier()
Job->>Scheduler : 任务失败
else 超时
Timeout->>Job : 触发超时事件
Job->>Job : 清理资源
Job->>Job : 调用_rejectBarrier()
Job->>Scheduler : 任务超时
end
Note over Job,Timeout : 实现健壮的错误处理和超时控制
```

**Section sources**
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [get-schema-job.ts](file://packages/h5-builder/src/jobs/get-schema-job.ts)

## 调度性能监控方案

### 任务耗时统计

系统内置性能监控功能，可记录每个任务在各阶段的执行耗时。

```mermaid
erDiagram
JOB_COST ||--o{ JOB : "属于"
JOB_COST ||--o{ PHASE : "发生在"
class JOB {
+name: string
+description: string
}
class PHASE {
+name: string
+description: string
}
class JOB_COST {
+jobName: string
+phase: string|number
+cost: number
+timestamp: datetime
}
note right of JOB_COST
记录每个任务在各阶段的耗时
支持性能分析和优化
end note
```

**Diagram sources**
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)

### 阻塞分析

通过分析任务等待状态，识别系统中的性能瓶颈和阻塞点。

```mermaid
graph TD
A[任务执行分析] --> B[识别阻塞任务]
B --> C[分析阻塞原因]
C --> D[网络请求]
C --> E[资源加载]
C --> F[计算密集型操作]
C --> G[依赖等待]
D --> H[优化方案]
E --> H
F --> H
G --> H
H --> I[并发控制]
H --> J[优先级调整]
H --> K[懒加载]
H --> L[缓存机制]
style B fill:#ffcdd2
style C fill:#b3e5fc
style H fill:#c8e6c9
```

**Section sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)

## 常见问题排查指南

### 任务死锁排查

```mermaid
flowchart TD
A[任务死锁现象] --> B[检查循环依赖]
B --> C[分析任务依赖图]
C --> D{是否存在循环}
D --> |是| E[打破循环依赖]
D --> |否| F[检查Barrier管理]
F --> G[确保_setBarrier后调用_openBarrier]
G --> H[检查异步任务完成状态]
H --> I[验证Promise正确解析]
style A fill:#ffcdd2
style B fill:#ffcdd2
style C fill:#b3e5fc
style D fill:#b3e5fc
style E fill:#c8e6c9
style F fill:#b3e5fc
style G fill:#b3e5fc
style H fill:#b3e5fc
style I fill:#c8e6c9
```

### 执行顺序错误排查

```mermaid
sequenceDiagram
participant Dev as 开发者
participant Code as 代码审查
participant Log as 日志分析
participant Fix as 问题修复
Dev->>Code : 检查任务注册阶段
Code->>Code : 验证生命周期阶段正确性
Code->>Log : 分析执行日志
Log->>Log : 确认实际执行顺序
Log->>Dev : 报告异常顺序
Dev->>Code : 检查依赖声明
Code->>Code : 验证_shouldWait逻辑
Code->>Fix : 调整注册阶段或依赖关系
Fix->>Dev : 问题解决确认
Note over Dev,Fix : 系统化排查执行顺序问题
```

**Section sources**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)