# 贡献指南

<cite>
**本文档中引用的文件**  
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [tsconfig.json](file://tsconfig.json)
- [scripts/build.js](file://scripts/build.js)
- [packages/h5-builder/package.json](file://packages/h5-builder/package.json)
- [packages/mobx-vue-lite/package.json](file://packages/mobx-vue-lite/package.json)
- [packages/h5-builder/vitest.config.ts](file://packages/h5-builder/vitest.config.ts)
- [packages/mobx-vue-lite/vitest.config.ts](file://packages/mobx-vue-lite/vitest.config.ts)
- [packages/h5-builder/tsconfig.build.json](file://packages/h5-builder/tsconfig.build.json)
- [packages/h5-builder/src/__tests__/setup.ts](file://packages/h5-builder/src/__tests__/setup.ts)
- [packages/h5-builder/src/__tests__/bridge.service.test.ts](file://packages/h5-builder/src/__tests__/bridge.service.test.ts)
- [packages/h5-builder/src/__tests__/model.test.ts](file://packages/h5-builder/src/__tests__/model.test.ts)
- [packages/mobx-vue-lite/src/__tests__/integration.test.tsx](file://packages/mobx-vue-lite/src/__tests__/integration.test.tsx)
- [packages/mobx-vue-lite/src/__tests__/comprehensive.test.tsx](file://packages/mobx-vue-lite/src/__tests__/comprehensive.test.tsx)
- [packages/h5-builder/src/bedrock/lock/README.md](file://packages/h5-builder/src/bedrock/lock/README.md)
- [packages/mobx-vue-lite/README.md](file://packages/mobx-vue-lite/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [环境搭建](#环境搭建)
3. [代码风格规范](#代码风格规范)
4. [测试策略](#测试策略)
5. [构建与发布流程](#构建与发布流程)
6. [问题报告与功能请求](#问题报告与功能请求)
7. [代码质量与文档](#代码质量与文档)

## 简介

本贡献指南旨在为开发者提供参与MobX项目开发的完整指导。项目采用Monorepo架构，包含多个功能包，如`@mobx-monorepo/h5-builder`和`mobx-vue-lite`，分别用于H5电商构建框架和轻量级响应式状态管理。本文档将详细介绍开发环境配置、编码规范、测试要求、构建流程以及贡献流程，确保所有贡献符合项目标准。

**Section sources**
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)

## 环境搭建

### 依赖安装
项目使用`pnpm`作为包管理器。首先确保已安装`pnpm`，然后在项目根目录运行：
```bash
pnpm install
```

`pnpm-workspace.yaml`文件定义了工作区包含`packages/*`目录下的所有包，实现了依赖的统一管理和共享。

### 开发工具配置
- **TypeScript**: 项目根目录的`tsconfig.json`提供了基础的TypeScript编译配置，包括目标ES6、模块解析、严格类型检查等。
- **Vite**: 各包使用Vite作为开发服务器和构建工具，配置文件为`vite.config.ts`。
- **Vitest**: 用于单元测试，配置文件为`vitest.config.ts`，使用`happy-dom`作为测试环境。

### 启动开发服务器
对于`h5-builder`包，可在其目录下运行：
```bash
pnpm demo
```
这将启动Vite开发服务器，便于实时开发和调试。

**Section sources**
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [tsconfig.json](file://tsconfig.json)
- [packages/h5-builder/package.json](file://packages/h5-builder/package.json)
- [packages/mobx-vue-lite/package.json](file://packages/mobx-vue-lite/package.json)
- [packages/h5-builder/vitest.config.ts](file://packages/h5-builder/vitest.config.ts)
- [packages/mobx-vue-lite/vitest.config.ts](file://packages/mobx-vue-lite/vitest.config.ts)

## 代码风格规范

### TypeScript编码标准
项目遵循严格的TypeScript编码规范，主要配置在根目录的`tsconfig.json`中：
- `strict: true`：启用所有严格类型检查选项
- `noImplicitReturns: true`：确保函数所有分支都有返回值
- `noUnusedLocals: true`：禁止未使用的局部变量
- `experimentalDecorators: true`：支持装饰器语法
- `useDefineForClassFields: true`：使用ES6类字段

### 提交信息格式
项目使用`changesets`进行版本管理和发布。提交信息应遵循清晰、描述性的原则，便于生成变更日志。建议使用以下格式：
```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
style: 代码格式调整
refactor: 代码重构
test: 添加或修改测试
chore: 构建过程或辅助工具的变动
```

**Section sources**
- [tsconfig.json](file://tsconfig.json)
- [package.json](file://package.json)

## 测试策略

### 单元测试
项目使用Vitest框架进行单元测试，测试文件位于各包的`src/__tests__`目录下。测试用例应覆盖核心功能、边界条件和错误处理。

#### 测试示例
- `bridge.service.test.ts`：测试桥接服务在模拟模式和原生模式下的行为，包括方法调用、错误处理和超时机制。
- `model.test.ts`：测试组件模型的生命周期（初始化、激活、销毁）、资源管理和响应式特性。

### 集成测试
集成测试验证多个组件或模块协同工作的正确性。`mobx-vue-lite`包中的`integration.test.tsx`和`comprehensive.test.tsx`提供了完整的集成测试示例，覆盖了：
- `observable`和`autorun`的响应式行为
- `computed`计算属性的自动更新
- `reaction`的副作用处理
- `observer`组件的细粒度重渲染
- `useLocalObservable`的本地状态管理

### 测试配置
- **setup.ts**: 在`packages/h5-builder/src/__tests__/setup.ts`中导入`@testing-library/jest-dom`以扩展Jest的断言能力。
- **vitest.config.ts**: 配置测试环境为`happy-dom`，支持全局变量，并设置覆盖率报告。

**Section sources**
- [packages/h5-builder/vitest.config.ts](file://packages/h5-builder/vitest.config.ts)
- [packages/h5-builder/src/__tests__/setup.ts](file://packages/h5-builder/src/__tests__/setup.ts)
- [packages/h5-builder/src/__tests__/bridge.service.test.ts](file://packages/h5-builder/src/__tests__/bridge.service.test.ts)
- [packages/h5-builder/src/__tests__/model.test.ts](file://packages/h5-builder/src/__tests__/model.test.ts)
- [packages/mobx-vue-lite/src/__tests__/integration.test.tsx](file://packages/mobx-vue-lite/src/__tests__/integration.test.tsx)
- [packages/mobx-vue-lite/src/__tests__/comprehensive.test.tsx](file://packages/mobx-vue-lite/src/__tests__/comprehensive.test.tsx)

## 构建与发布流程

### Monorepo包管理
项目采用Monorepo架构，通过`pnpm`的工作区功能管理多个包。`pnpm-workspace.yaml`文件指定了工作区包含`packages/*`下的所有包，实现了依赖的高效共享和版本同步。

### 构建脚本
项目根目录的`package.json`定义了构建脚本：
```json
"scripts": {
  "build": "pnpm -r build"
}
```
该命令会在所有包中递归执行各自的`build`脚本。

各包的构建配置：
- `h5-builder`：使用`tsc -p tsconfig.build.json`进行TypeScript编译，`tsconfig.build.json`继承自根配置并排除测试文件。
- `mobx-vue-lite`：直接使用`tsc`进行编译。

### 发布流程
项目的构建和发布由`scripts/build.js`脚本控制。该脚本根据目标参数（`publish`或`test`）执行不同的构建策略：
- **发布模式**：生成开发和生产环境的ESM包，以及压缩版本，确保浏览器友好。
- **测试模式**：仅生成CJS包，用于CI环境的快速测试。

构建流程包括：
1. 清理临时目录
2. 执行TSDX构建（支持ESM、CJS、UMD格式）
3. 移动和重命名构建产物
4. 生成源码映射文件

**Section sources**
- [package.json](file://package.json)
- [pnpm-workspace.yaml](file://pnpm-workspace.yaml)
- [scripts/build.js](file://scripts/build.js)
- [packages/h5-builder/package.json](file://packages/h5-builder/package.json)
- [packages/h5-builder/tsconfig.build.json](file://packages/h5-builder/tsconfig.build.json)

## 问题报告与功能请求

### 问题报告
报告问题时，请提供：
- 清晰的问题描述
- 复现步骤
- 预期行为与实际行为
- 环境信息（操作系统、Node.js版本、包版本）
- 相关错误日志或截图

### 功能请求
提出新功能时，请说明：
- 功能目的和使用场景
- API设计建议
- 与其他功能的集成方式
- 潜在的技术挑战

所有问题和功能请求应通过项目的GitHub Issues系统提交，便于跟踪和讨论。

## 代码质量与文档

### 代码质量
项目通过以下方式保证代码质量：
- **静态检查**：使用ESLint进行代码风格和潜在错误检查。
- **格式化**：使用Prettier统一代码格式，`package.json`中的`prettier`脚本可自动格式化代码。
- **预提交钩子**：通过Husky配置`pre-commit`钩子，使用`pretty-quick`在提交前自动格式化暂存文件。

### 文档更新
贡献代码时，必须同步更新相关文档：
- **README.md**：如`packages/mobx-vue-lite/README.md`和`packages/h5-builder/src/bedrock/lock/README.md`，应清晰描述包的功能、API和使用示例。
- **代码注释**：关键逻辑和复杂算法应添加详细注释。
- **类型定义**：确保TypeScript类型准确反映API契约。

所有贡献都应遵循项目标准，确保代码的可维护性和可读性。

**Section sources**
- [package.json](file://package.json)
- [packages/mobx-vue-lite/README.md](file://packages/mobx-vue-lite/README.md)
- [packages/h5-builder/src/bedrock/lock/README.md](file://packages/h5-builder/src/bedrock/lock/README.md)