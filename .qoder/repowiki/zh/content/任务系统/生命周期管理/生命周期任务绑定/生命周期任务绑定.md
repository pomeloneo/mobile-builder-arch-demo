# 生命周期任务绑定

<cite>
**本文档引用的文件**
- [init-first-screen-data-job.ts](file://packages/h5-builder/src/jobs/init-first-screen-data-job.ts)
- [load-components-job.ts](file://packages/h5-builder/src/jobs/load-components-job.ts)
- [ensure-view-ready.ts](file://packages/h5-builder/src/jobs/ensure-view-ready.ts)
- [activate-tree-job.ts](file://packages/h5-builder/src/jobs/activate-tree-job.ts)
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [phase-emitter.ts](file://packages/h5-builder/src/bedrock/event/phase-emitter.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)
- [schema.service.ts](file://packages/h5-builder/src/services/schema.service.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)
- [demo-progressive.tsx](file://packages/h5-builder/src/demo-progressive.tsx)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [生命周期阶段定义](#生命周期阶段定义)
3. [Job调度器与依赖注入系统](#job调度器与依赖注入系统)
4. [核心Job类分析](#核心job类分析)
5. [Job执行流程与阶段协调](#job执行流程与阶段协调)
6. [自定义Job扩展机制](#自定义job扩展机制)
7. [错误处理与性能监控](#错误处理与性能监控)

## 项目结构

项目采用分层架构设计，核心生命周期管理位于`packages/h5-builder/src/jobs/`目录下，通过依赖注入（DI）系统协调各个组件的初始化和执行。Job调度机制与事件发射器共同构成了应用启动的核心流程。

```mermaid
graph TB
subgraph "生命周期管理"
JobScheduler[Job调度器]
PhaseEmitter[阶段事件发射器]
end
subgraph "核心服务"
ComponentService[组件服务]
SchemaService[Schema服务]
end
subgraph "Job任务"
GetSchemaJob[获取Schema任务]
LoadComponentsJob[加载组件任务]
BuildTreeJob[构建树任务]
InitFirstScreenDataJob[首屏数据初始化]
ActivateTreeJob[激活树任务]
EnsureViewReadyJob[确保视图就绪]
end
JobScheduler --> PhaseEmitter
JobScheduler --> ComponentService
JobScheduler --> SchemaService
GetSchemaJob --> JobScheduler
LoadComponentsJob --> JobScheduler
BuildTreeJob --> JobScheduler
InitFirstScreenDataJob --> JobScheduler
ActivateTreeJob --> JobScheduler
EnsureViewReadyJob --> JobScheduler
```

**图示来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [phase-emitter.ts](file://packages/h5-builder/src/bedrock/event/phase-emitter.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**本节来源**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)

## 生命周期阶段定义

系统定义了清晰的页面生命周期阶段，每个阶段对应特定的初始化任务。这些阶段通过枚举`PageLifecycle`进行管理，确保了应用启动过程的有序性和可预测性。

```mermaid
stateDiagram-v2
[*] --> Open
Open --> LoadComponentLogic : 获取Schema完成
LoadComponentLogic --> Prepare : 组件逻辑加载完成
Prepare --> RenderReady : 模型树构建完成
RenderReady --> Render : 视图资源准备就绪
Render --> Completed : 渲染完成
Completed --> Idle : 首屏数据填充完成
Idle --> [*]
state Open {
[*] --> "页面打开，正在拉取 schema 中... & 并注册组件资源加载器"
}
state LoadComponentLogic {
[*] --> "加载组件逻辑 Model JS 资源中..."
}
state Prepare {
[*] --> "构建模型树也就是逻辑树)、同时登台组件视图加载中..."
}
state RenderReady {
[*] --> "模型树和视图资源全部准备完成"
}
state Render {
[*] --> "启动渲染"
}
state Completed {
[*] --> "首屏视图数据填充中..."
}
state Idle {
[*] --> "处于空闲空闲空闲空闲空闲阶段"
}
```

**图示来源**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)

**本节来源**
- [lifecycle.ts](file://packages/h5-builder/src/jobs/lifecycle.ts)

## Job调度器与依赖注入系统

Job调度器（JobScheduler）是整个生命周期管理的核心，它通过依赖注入系统创建和管理各个Job实例。调度器与阶段事件发射器（PhaseEmitter）协同工作，确保任务按正确的顺序执行。

```mermaid
classDiagram
class JobScheduler {
+currentPhase : K
+registerJob(phase : K, ctor : Constructor, ...args : any[])
+addJob(job : AbstractJob)
+prepare(phase : K)
+wait(phase : K)
+advanceToPhase(phase : K)
+getCost()
}
class AbstractJob {
+name : string
+shouldWait(phase : K) : boolean
+wait(phase : K) : Promise~void~
+prepare(phase : K)
+_setBarrier(phase : K, barrier : Barrier)
+_executePhase(phase : K) : void
}
class PhaseEmitter {
+currentPhase : K
+whenPhase : WhenPhaseEvent~T~
+when(phase : K) : PhaseEvent
+setPhase(phase : K)
+fire(phase : K)
}
class Barrier {
+isOpen() : boolean
+open() : void
+wait() : Promise~boolean~
}
JobScheduler --> AbstractJob : "管理"
JobScheduler --> PhaseEmitter : "协调"
AbstractJob --> Barrier : "使用"
PhaseEmitter --> Event : "实现"
```

**图示来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)
- [phase-emitter.ts](file://packages/h5-builder/src/bedrock/event/phase-emitter.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)

**本节来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [phase-emitter.ts](file://packages/h5-builder/src/bedrock/event/phase-emitter.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)

## 核心Job类分析

### InitFirstScreenDataJob 首屏数据初始化

`InitFirstScreenDataJob`负责在页面渲染完成后初始化首屏数据。该任务在`Completed`阶段执行，通过组件服务获取根模型并调用其`init`方法来加载数据。

```mermaid
sequenceDiagram
participant JobScheduler
participant InitFirstScreenDataJob
participant ComponentService
participant RootModel
JobScheduler->>InitFirstScreenDataJob : prepare(Completed)
InitFirstScreenDataJob->>InitFirstScreenDataJob : _executePhase(Completed)
InitFirstScreenDataJob->>InitFirstScreenDataJob : _whenCompleted()
InitFirstScreenDataJob->>ComponentService : getModelTree()
ComponentService-->>InitFirstScreenDataJob : 返回根模型
InitFirstScreenDataJob->>RootModel : init()
RootModel-->>InitFirstScreenDataJob : 数据加载完成
InitFirstScreenDataJob->>InitFirstScreenDataJob : 打开Barrier
```

**图示来源**
- [init-first-screen-data-job.ts](file://packages/h5-builder/src/jobs/init-first-screen-data-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**本节来源**
- [init-first-screen-data-job.ts](file://packages/h5-builder/src/jobs/init-first-screen-data-job.ts)

### LoadComponentsJob 组件资源加载

`LoadComponentsJob`负责异步加载组件的逻辑资源（Model JS）。该任务在`LoadComponentLogic`阶段执行，通过组件服务的`getModelTreeReady`方法并发加载所有必要的组件资源。

```mermaid
sequenceDiagram
participant JobScheduler
participant LoadComponentsJob
participant ComponentService
participant Loader
JobScheduler->>LoadComponentsJob : prepare(LoadComponentLogic)
LoadComponentsJob->>LoadComponentsJob : _executePhase(LoadComponentLogic)
LoadComponentsJob->>LoadComponentsJob : _whenLoadComponentLogic()
LoadComponentsJob->>ComponentService : getModelTreeReady()
ComponentService->>ComponentService : preloadComponentsUnified()
ComponentService->>Loader : loadModel(componentName)
Loader-->>ComponentService : Model Promise
ComponentService->>Loader : loadModel(componentName)
Loader-->>ComponentService : Model Promise
ComponentService-->>LoadComponentsJob : 所有Model加载完成
LoadComponentsJob->>LoadComponentsJob : 打开Barrier
```

**图示来源**
- [load-components-job.ts](file://packages/h5-builder/src/jobs/load-components-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**本节来源**
- [load-components-job.ts](file://packages/h5-builder/src/jobs/load-components-job.ts)

### EnsureViewReady 确保视图准备就绪

`EnsureViewReadyJob`负责确保视图资源准备就绪。该任务在`RenderReady`阶段执行，通过组件服务的`getViewsReady`方法等待所有视图资源加载完成。

```mermaid
sequenceDiagram
participant JobScheduler
participant EnsureViewReadyJob
participant ComponentService
participant ViewLoader
JobScheduler->>EnsureViewReadyJob : prepare(RenderReady)
EnsureViewReadyJob->>EnsureViewReadyJob : _executePhase(RenderReady)
EnsureViewReadyJob->>EnsureViewReadyJob : _whenRenderReady()
EnsureViewReadyJob->>ComponentService : getViewsReady()
ComponentService->>ViewLoader : loadView(componentName)
ViewLoader-->>ComponentService : View Promise
ComponentService->>ViewLoader : loadView(componentName)
ViewLoader-->>ComponentService : View Promise
ComponentService-->>EnsureViewReadyJob : 所有视图资源加载完成
EnsureViewReadyJob->>EnsureViewReadyJob : 打开Barrier
```

**图示来源**
- [ensure-view-ready.ts](file://packages/h5-builder/src/jobs/ensure-view-ready.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**本节来源**
- [ensure-view-ready.ts](file://packages/h5-builder/src/jobs/ensure-view-ready.ts)

### ActivateTreeJob 激活模型树

`ActivateTreeJob`负责激活整个组件树。该任务在`Render`阶段执行，通过组件服务获取模型树并调用其`activate`方法来启动组件的副作用（如埋点上报、定时器等）。

```mermaid
sequenceDiagram
participant JobScheduler
participant ActivateTreeJob
participant ComponentService
participant ModelTree
JobScheduler->>ActivateTreeJob : prepare(Render)
ActivateTreeJob->>ActivateTreeJob : _executePhase(Render)
ActivateTreeJob->>ActivateTreeJob : _whenActivate()
ActivateTreeJob->>ComponentService : getModelTree()
ComponentService-->>ActivateTreeJob : 返回模型树
ActivateTreeJob->>ModelTree : activate()
ModelTree->>ModelTree : 启动埋点
ModelTree->>ModelTree : 启动定时器
ModelTree-->>ActivateTreeJob : 激活完成
```

**图示来源**
- [activate-tree-job.ts](file://packages/h5-builder/src/jobs/activate-tree-job.ts)
- [component.service.ts](file://packages/h5-builder/src/services/component.service.ts)

**本节来源**
- [activate-tree-job.ts](file://packages/h5-builder/src/jobs/activate-tree-job.ts)

## Job执行流程与阶段协调

Job的执行流程通过`JobScheduler`的`prepare`和`wait`方法进行协调。每个阶段的执行分为两个步骤：准备（prepare）和等待（wait）。这种设计确保了任务的有序执行和异步操作的正确处理。

```mermaid
flowchart TD
Start([开始]) --> OpenPhase["Open 阶段"]
OpenPhase --> PrepareOpen["JobScheduler.prepare(Open)"]
PrepareOpen --> WaitOpen["JobScheduler.wait(Open)"]
WaitOpen --> LoadComponentLogicPhase["LoadComponentLogic 阶段"]
LoadComponentLogicPhase --> PrepareLoad["JobScheduler.prepare(LoadComponentLogic)"]
PrepareLoad --> WaitLoad["JobScheduler.wait(LoadComponentLogic)"]
WaitLoad --> PreparePhase["Prepare 阶段"]
PreparePhase --> PreparePrepare["JobScheduler.prepare(Prepare)"]
PreparePrepare --> WaitPrepare["JobScheduler.wait(Prepare)"]
WaitPrepare --> RenderReadyPhase["RenderReady 阶段"]
RenderReadyPhase --> PrepareRenderReady["JobScheduler.prepare(RenderReady)"]
PrepareRenderReady --> WaitRenderReady["JobScheduler.wait(RenderReady)"]
WaitRenderReady --> RenderPhase["Render 阶段"]
RenderPhase --> PrepareRender["JobScheduler.prepare(Render)"]
PrepareRender --> WaitRender["JobScheduler.wait(Render)"]
WaitRender --> CompletedPhase["Completed 阶段"]
CompletedPhase --> PrepareCompleted["JobScheduler.prepare(Completed)"]
PrepareCompleted --> WaitCompleted["JobScheduler.wait(Completed)"]
WaitCompleted --> IdlePhase["Idle 阶段"]
IdlePhase --> PrepareIdle["JobScheduler.prepare(Idle)"]
PrepareIdle --> WaitIdle["JobScheduler.wait(Idle)"]
WaitIdle --> End([完成])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
```

**图示来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [demo-progressive.tsx](file://packages/h5-builder/src/demo-progressive.tsx)

**本节来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [demo-progressive.tsx](file://packages/h5-builder/src/demo-progressive.tsx)

## 自定义Job扩展机制

系统提供了灵活的自定义Job扩展机制，允许开发者注册新的Job来扩展生命周期流程。通过`JobScheduler`的`registerJob`方法，可以将自定义Job绑定到特定的生命周期阶段。

```mermaid
classDiagram
class CustomJob {
+name : string
+_executePhase(phase : PageLifecycle)
}
class JobScheduler {
+registerJob(phase : K, ctor : Constructor, ...args : any[])
}
JobScheduler --> CustomJob : "注册"
note right of JobScheduler
registerJob方法将自定义Job
与特定生命周期阶段关联
end
note right of CustomJob
自定义Job必须继承
AbstractJob基类并实现
_executePhase方法
end
```

**图示来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)

**本节来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [abstract-job.ts](file://packages/h5-builder/src/bedrock/launch/abstract-job.ts)

## 错误处理与性能监控

系统内置了完善的错误处理和性能监控机制。通过`CostRecorder`记录每个Job的执行时间，帮助开发者优化性能。同时，Barrier机制确保了异步操作的正确完成，即使在出错情况下也能保持系统的稳定性。

```mermaid
flowchart LR
JobExecution[Job执行] --> Success{"执行成功?"}
Success --> |是| RecordCost["记录执行时间"]
Success --> |否| HandleError["处理错误"]
RecordCost --> Complete["任务完成"]
HandleError --> OpenBarrier["打开Barrier"]
OpenBarrier --> Complete
style Success fill:#f96,stroke:#333
style RecordCost fill:#6f9,stroke:#333
style HandleError fill:#f66,stroke:#333
style Complete fill:#9f6,stroke:#333
```

**图示来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)

**本节来源**
- [job-scheduler.ts](file://packages/h5-builder/src/bedrock/launch/job-scheduler.ts)
- [cost-recorder.ts](file://packages/h5-builder/src/bedrock/launch/cost-recorder.ts)
- [barrier.ts](file://packages/h5-builder/src/bedrock/async/barrier.ts)